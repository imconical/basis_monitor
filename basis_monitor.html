<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>实时基差监控</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5"></script>
    <style>
        body {
            display: flex;
            flex-wrap: wrap;
            margin: 0;
            padding: 0;
        }
        .chart-container {
            width: 50%; /* 横向一半，纵向一半，总面积1/4 */
            height: 50vh;
            box-sizing: border-box;
            padding: 10px;
        }
    </style>
</head>
<body>
    <div class="chart-container">
        <h3>IC基差实时监控</h3>
        <div id="chart" style="width: 100%; height: 90%;"></div>
    </div>

    <script>
        const chartDom = document.getElementById('chart');
        const myChart = echarts.init(chartDom);

        // 生成固定时间轴
        function generateTimeAxis() {
            const times = [];

            // 上午 9:30 - 11:30
            for (let h = 9; h <= 11; h++) {
                let startM = (h === 9) ? 30 : 0;
                let endM = (h === 11) ? 30 : 59;
                for (let m = startM; m <= endM; m++) {
                    times.push(`${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`);
                }
            }

            // 下午 13:00 - 15:00
            for (let h = 13; h <= 15; h++) {
                let endM = (h === 15) ? 0 : 59;
                for (let m = 0; m <= endM; m++) {
                    times.push(`${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`);
                }
            }
            return times;
        }

        const timeAxis = generateTimeAxis();
        const basisData = new Array(timeAxis.length).fill(null);  // 初始化为空

        const option = {
            title: { text: '实时基差分时图', left: 'center', top: 10 },
            tooltip: { trigger: 'axis' },
            grid: { left: '10%', right: '10%', bottom: '10%' },
            xAxis: { type: 'category', data: timeAxis },
            yAxis: { type: 'value', name: '基差' },
            series: [
                { name: '实时基差', type: 'line', data: basisData, smooth: true, showSymbol: false }
            ]
        };

        myChart.setOption(option);

        const ws = new WebSocket("ws://localhost:8765/");
        ws.onmessage = function(event) {
            const data = JSON.parse(event.data);
            // 由于后端传的是完整历史数组（时间按秒精度），需要对齐到分钟：
            for (const item of data) {
                const t = item.time.substring(0,5);  // 截取 HH:MM
                const idx = timeAxis.indexOf(t);
                if (idx !== -1) {
                    basisData[idx] = item.basis;
                }
            }
            myChart.setOption({ series: [{ data: basisData }] });
        };
    </script>
</body>
</html>
